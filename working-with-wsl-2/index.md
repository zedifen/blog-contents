---
title: 使用 WSL 2 进行工作
date: 2022-05-19 01:26:28
description: WSL 2 使用过程中的一些注意事项.
tags: ['windows', 'wsl2']
---

了解 WSL 2 : [适用于 Linux 的 Windows 子系统文档 - Microsoft Docs](https://docs.microsoft.com/zh-cn/windows/wsl/) (微软文档)

为什么使用 WSL? : [为什么这么多人吹 WSL? - 知乎](https://www.zhihu.com/question/393170756)

## Installation

安装 WSL 2: [设置 WSL 开发环境 - Microsoft Docs](https://docs.microsoft.com/zh-cn/windows/wsl/setup/environment)

...

## Networking

最主要的是网络问题. 一般日常工作需要, 需要 WSL2 和主机能够互相访问.

WSL 2 作为 Hyper-V 虚拟机运行, 不同于 WSL 1 的桥接, 其使用网络地址转换 (NAT) 服务作为其虚拟网络 [^compare-versions]. 因此, 主机和 WSL 2 需要首先得知对方在该虚拟网络下的 IP 地址才能互相通信. 需要注意, 每次重启主机, 该 IP 地址都会发生变化.


可以通过下面的方法获取主机和 WSL 2 的 IP [^get-ip]:

在运行的 WSL 2 上, 可以通过访问  `/etc/resolv.conf`, 从而得知主机在该网络下的地址:

```shell{outputLines: 2-5,7}
cat /etc/resolv.conf
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 172.21.160.1
cat /etc/resolv.conf | grep nameserver | awk '{ print $2 }
172.21.160.1
```


可以通过 `hostname -I` 得到 WSL 2 的 IP.

```shell{outputLines: 2}
hostname -I | awk '{print $1}'
172.21.172.66 
```

但是, 要想 WSL 2 成功访问主机, 还需要主机放开防火墙规则. 可以参考下面的 PowerShell 命令 (需要管理员权限) [^disable-win-firewall], 解除 Windows 主机上针对 WSL 虚拟网卡的防火墙规则:

```powershell
# 直接放开 `vEthernet (WSL)` 这张网卡的防火墙
New-NetFirewallRule -DisplayName "WSL" -Direction Inbound -InterfaceAlias "vEthernet (WSL)" -Action Allow
```


### Proxy

从前文可以看出, WSL 2 的网络配置略显复杂, 因此先考虑在 WSL2 上直接运行代理程序 (Clash), 未果, 不能与网络代理服务提供商的服务器正常通信 (猜测可能是时区问题).

折腾许久不得, 于是作罢, 还是尝试使用主机上运行的代理程序.

WSL 2 对主机上程序的访问, 相当于来自局域网的访问. 因此, 需要打开代理软件 "**允许来自局域网的连接** (Allow LAN)" 的设置. 同时, 除了前文说到的 **放行 WSL 2 的网卡** 外, 还需要 **允许代理软件通过防火墙** [^pass-firewall] (可能会在第一次开启代理软件的 "Allow LAN" 的时候弹出提醒).

之后, 便可以在 WSL 2 上使用主机上的代理了.


备注: 尚未研究 SSH 的代理. 可以参考:

[wizcas/wsl2proxy - github.com](https://github.com/wizcas/wsl2proxy)

### 端口转发

从局域网访问主机上的 WSL 2, 可以参考; 因本人暂无需求, 故尚未研究. 下面仅备注一些可能相关的链接.

[如何在局域网的其他主机上中访问本机的 WSL2 - 知乎](https://zhuanlan.zhihu.com/p/425312804)

[Windows 10 WSL 2 网络配置 | ruihusky's Blog](https://ruihusky.github.io/ruihusky/posts/2020-12-11_wsl2-net-config/)


[^compare-versions]: [比较 WSL 1 和 WSL 2 - Microsoft Docs](https://docs.microsoft.com/zh-cn/windows/wsl/compare-versions)


[^get-ip]: [#WSL 中获取宿主机 IP - WSL 2 中访问宿主机 Windows 的代理 - ZingLix Blog](https://zinglix.xyz/2020/04/18/wsl2-proxy/#wsl-中获取宿主机-ip)


[^disable-win-firewall]: 来自 [WSL 2 的一些网络访问问题 | Artin's Blog (bytem.io)](https://bytem.io/posts/wsl2-network-tricks/), 引用自 [Issue #4585 · microsoft/WSL](https://github.com/microsoft/WSL/issues/4585). 前者还提到了使用 TUN 模式代理整张网卡的流量.


[^pass-firewall]: [WSL 2 来了! 但是能正常使用并不简单 - Wizcas - 知乎](https://zhuanlan.zhihu.com/p/144583887) (Also available at [0x1C.dev](https://0x1c.dev/blog/dev/make-wsl2-right/)); 该文章参考了 [在 WSL 2 中访问主机代理 - Geek 成长路 (rogerkung-win.top)](https://blog.rogerkung-win.top/posts/38819/).

## File System

虽然 Windows 的文件系统挂载在了 WSL 2 上, Windows 中也可以直接在资源管理器中访问 WSL 2 上的文件系统. 但是建议, 在可能的情况下, 还是将文件放在 WSL 2 中处理, 尽量不要跨系统进行操作.

## Misc

[WSL 2 踩坑分享 - xiabee](https://xiabee.cn/coding/wsl2/)

